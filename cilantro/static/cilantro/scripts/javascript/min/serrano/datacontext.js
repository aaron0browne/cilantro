var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};define(["underscore","backbone"],function(_,Backbone){var DataContext,DataContextNode,DataContexts,isBranch,isComposite,isCondition;return isBranch=function(attrs){var _ref;return(attrs.type==="and"||attrs.type==="or")&&((_ref=attrs.children)!=null?_ref.length:void 0)>=2},isCondition=function(attrs){return attrs.operator&&attrs.id&&attrs.value!==void 0},isComposite=function(attrs){return attrs.composite===!0&&attrs.id},DataContextNode=function(_super){function DataContextNode(){return DataContextNode.__super__.constructor.apply(this,arguments)}return __extends(DataContextNode,_super),DataContextNode.prototype.validate=function(attrs){var key,value;if(isBranch(attrs)||isCondition(attrs)||isComposite(attrs))return;for(key in attrs){value=attrs[key];if(value!==void 0)return"Unknown node type"}},DataContextNode.prototype.toJSON=function(){var json;return this.isBranch()?json={type:this.get("type"),children:_.map(this.get("children"),function(model){return model.toJSON()})}:json=DataContextNode.__super__.toJSON.apply(this,arguments),json},DataContextNode.prototype.isRoot=function(){return this.parent==null},DataContextNode.prototype.isEmpty=function(){return _.isEmpty(this.attributes)},DataContextNode.prototype.isBranch=function(){return isBranch(this.attributes)},DataContextNode.prototype.isCondition=function(){return isCondition(this.attributes)},DataContextNode.prototype.isComposite=function(){return isComposite(this.attributes)},DataContextNode.prototype.siblings=function(){return this.isRoot()?!1:_.without(this.parent.get("children"),this)},DataContextNode.prototype.promote=function(){var children,nodes,type,_this=this;nodes=1<=arguments.length?__slice.call(arguments,0):[];if(nodes.length===0)throw new Error("At least one node must be supplied");return this.isRoot()?type="and":type=this.parent.get("type")==="and"?"or":"and",children=_.map([this.attributes].concat(__slice.call(nodes)),function(attrs){return DataContextNode.parseAttrs(attrs,_this)}),this.clear({slient:!0}),this.set({type:type,children:children}),this},DataContextNode.prototype.demote=function(){return this.isRoot()?!1:this.parent.isRoot()?this.siblings().length===0?(this.parent.clear({silent:!0}),this.parent.set(this.attributes),this.parent):!1:(this.parent.parent.get("children").push(this.remove()),this)},DataContextNode.prototype.add=function(){var children,nodes,_this=this;nodes=1<=arguments.length?__slice.call(arguments,0):[];if(!this.isBranch())throw new Error('Node is not a branch. Use "promote" to convert it into one');return(children=this.get("children")).push.apply(children,_.map(nodes,function(attrs){return DataContextNode.parseAttrs(attrs,_this)})),this},DataContextNode.prototype.remove=function(){var children,idx;return this.isRoot()?this.clear():(children=this.parent.get("children"),(idx=children.indexOf(this))>=0&&(children.splice(idx,1)[0],children.length===1&&children[0].demote())),this},DataContextNode}(Backbone.Model),DataContextNode.parseAttrs=function(attrs,parent,callback){var children,node;if(!attrs)node=new DataContextNode;else if(attrs instanceof DataContextNode)node=attrs;else if(isBranch(attrs))node=new DataContextNode({type:attrs.type}),children=_.map(attrs.children,function(_attrs){return DataContextNode.parseAttrs(_attrs,node,callback)}),node.set({children:children});else if(isCondition(attrs))node=new DataContextNode(attrs);else{if(!isComposite(attrs))throw new Error("Unknown node type");node=new DataContextNode(attrs)}return parent&&(node.parent=parent),typeof callback=="function"&&callback(node),node},DataContextNode.updateAttrs=function(node,attrs){var children,i,_attrs,_i,_len,_ref,_results;if(node.isBranch()){children=node.get("children"),_ref=attrs.children,_results=[];for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)_attrs=_ref[i],_results.push(DataContextNode.updateAttrs(children[i],_attrs));return _results}return node.set(attrs)},DataContext=function(_super){function DataContext(){return this._deferenceNode=__bind(this._deferenceNode,this),this._cacheNode=__bind(this._cacheNode,this),this.parse=__bind(this.parse,this),DataContext.__super__.constructor.apply(this,arguments)}return __extends(DataContext,_super),DataContext.prototype.initialize=function(){var _ref;return(_ref=this.nodes)!=null?_ref:this.nodes={}},DataContext.prototype.url=function(){return this.isNew()?DataContext.__super__.url.apply(this,arguments):this.get("url")},DataContext.prototype.parse=function(resp){return resp&&(this.node?DataContextNode.updateAttrs(this.node,resp.json):(this.nodes={},this.node=DataContextNode.parseAttrs(resp.json,null,this._cacheNode))),resp},DataContext.prototype.toJSON=function(){var attrs;return attrs=DataContext.__super__.toJSON.apply(this,arguments),this.node&&(attrs.json=this.node.toJSON()),attrs},DataContext.prototype.isRoot=function(){return this.node.isRoot()},DataContext.prototype.isEmpty=function(){return this.node.isEmpty()},DataContext.prototype.isBranch=function(){return this.node.isBranch()},DataContext.prototype.isCondition=function(){return this.node.isCondition()},DataContext.prototype.isComposite=function(){return this.node.isComposite()},DataContext.prototype._cacheNode=function(node){var cache;if(node.id){(cache=this.nodes[node.id])||(cache=this.nodes[node.id]=[]);if(cache.indexOf(node)===-1)return cache.push(node)}},DataContext.prototype._deferenceNode=function(node){var cache,idx;if((cache=this.nodes[node.id])&&(idx=cache.indexOf(node))>=0)return cache.splice(idx,1)},DataContext.prototype.getNodes=function(id){return this.nodes[id]||[]},DataContext.prototype.promote=function(){var node,nodes,_ref;return node=arguments[0],nodes=2<=arguments.length?__slice.call(arguments,1):[],node===null?(_ref=this.node).promote.apply(_ref,nodes):node.promote.apply(node,nodes),this.save()},DataContext.prototype.demote=function(node){return node.demote(),this.save()},DataContext.prototype.add=function(){var node,nodes,_i,_len,_ref;node=arguments[0],nodes=2<=arguments.length?__slice.call(arguments,1):[],node||(this.node.isEmpty()?(this.node=nodes[0],this._cacheNode(this.node)):node=this.node);if(node){node.add.apply(node,nodes),_ref=node.get("children");for(_i=0,_len=_ref.length;_i<_len;_i++)node=_ref[_i],this._cacheNode(node)}return this.save()},DataContext.prototype.remove=function(node){return node=node||this.node,node.remove(),node.isRoot()||this._deferenceNode(node),this.save()},DataContext}(Backbone.Model),DataContexts=function(_super){function DataContexts(){return DataContexts.__super__.constructor.apply(this,arguments)}return __extends(DataContexts,_super),DataContexts.prototype.model=DataContext,DataContexts.prototype.getSession=function(){return this.filter(function(model){return model.get("session")})[0]},DataContexts}(Backbone.Collection),{DataContextNode:DataContextNode,DataContext:DataContext,DataContexts:DataContexts}})