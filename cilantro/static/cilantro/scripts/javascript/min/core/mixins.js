define(["jquery","underscore"],function($,_){var Deferrable,addOnceDeferreds;return addOnceDeferreds=function(obj){var args,func,name,_ref,_ref1,_results;_ref=obj._deferred.once,_results=[];for(name in _ref)_ref1=_ref[name],func=_ref1[0],args=_ref1[1],_results.push(obj._deferred.done(function(args){return func.apply(null,args)}(args)));return _results},Deferrable={deferred:{},initialize:function(){var func,method,once,_ref,_results,_this=this;this.pending(),_ref=this.deferred,_results=[];for(method in _ref)once=_ref[method],func=this[method],_results.push(this[method]=function(){return _this.defer(method,func,once,arguments)});return _results},pending:function(){return(this._deferred=$.Deferred()).once={},this},defer:function(name,func,once,args){once==null&&(once=!1),this._deferred==null&&this.pending();if(_.isString(name)){_.isBoolean(func)&&(once=func,func=this[name]);if(once&&this._deferred.state()==="pending")return this._deferred.once[name]=[func,args],this}else func=name;return this._deferred.done(function(){return func.apply(null,args)}),this},resolve:function(context){return context==null&&(context=this),this._deferred&&(addOnceDeferreds(this),this._deferred.resolveWith(context)),this},reject:function(context){return context==null&&(context=this),this._deferred&&(addOnceDeferreds(this),this._deferred.rejectWith(context)),this},promise:function(){var _ref;return this._deferred==null&&this.pending(),(_ref=this._deferred).promise.apply(_ref,arguments)},when:function(func){return $.when(this).done(func)},state:function(){return this._deferred.state()}},Deferrable.resolveWith=Deferrable.resolve,Deferrable.rejectWith=Deferrable.reject,{Deferrable:Deferrable}})