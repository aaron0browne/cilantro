var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define(["environ","mediator","jquery","backbone","charts/utils","backbone.charts"],function(environ,mediator,$,Backbone,utils){var DataFieldDistribution,DistributionChart,chartTmpl,urlTmpl;return urlTmpl=_.template(environ.absolutePath("/api/fields/{{ id }}/dist/")),chartTmpl=_.template('        <div class="area-container chart-container">            <div class=btn-toolbar>                <div class=btn-group>                    <button class="btn btn-mini fullsize" title="Toggle Fullsize"><i class=icon-resize-full alt="Toggle Fullsize"></i></button>                    <!--<button class="btn btn-mini outliers" title="Show Outliers" disabled><i class=icon-eye-open alt="Show Outliers"></i></button>-->                </div>                <div class=btn-group>                    <button class="btn btn-mini edit" title="Edit"><i class=icon-wrench alt="Edit"></i></button>                </div>                <div class=btn-group>                    <button class="btn btn-danger btn-mini remove" title="Remove"><i class=icon-remove alt="Remove"></i></button>                </div>            </div>            <div class=heading>                <span class="label label-info"></span>            </div>            <div class=editable>                <form class=form>                    <fieldset>                        <label>X-Axis <select name=x-axis></select></label>                        <label>Y-Axis <select name=y-axis></select></label>                        <label>Series <select name=series></select></label>                        <button class="btn btn-primary">Update</button>                    </fieldset>                </form>            </div>            <div class=chart>            </div>        </div>    '),DataFieldDistribution=function(_super){function DataFieldDistribution(){return DataFieldDistribution.__super__.constructor.apply(this,arguments)}return __extends(DataFieldDistribution,_super),DataFieldDistribution.prototype.tagName="select",DataFieldDistribution.prototype.initialize=function(options){var _this=this;return this.options=options,this.enumerableOnly=options.enumerableOnly,this.collection.deferred.done(function(){return _this.render()})},DataFieldDistribution.prototype.render=function(){var data,model,_i,_len,_ref;this.$el.append("<option value=>---</option>"),_ref=this.collection.models;for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if((data=model.get("data")).searchable)continue;data=model.get("data");if(this.enumerableOnly&&!data.enumerable)continue;this.$el.append("<option value="+model.id+">"+model.get("name")+" ["+model.get("model_name")+"]</option>")}return this},DataFieldDistribution.prototype.getSelected=function(){return this.collection.get(parseInt(this.$el.val()))},DataFieldDistribution}(Backbone.View),DistributionChart=function(_super){function DistributionChart(){return DistributionChart.__super__.constructor.apply(this,arguments)}return __extends(DistributionChart,_super),DistributionChart.prototype.events={mouseenter:"showToolbar",mouseleave:"hideToolbar","click .fullsize":"toggleExpanded","click .outliers":"toggleOutliers","click .edit":"toggleEdit","click .remove":"removeChart",submit:"updateChart","change .editable select":"disableRedundantFields"},DistributionChart.prototype.initialize=function(options){var expanded;this.setElement(chartTmpl()),this.$heading=this.$(".heading"),this.$label=this.$heading.find(".label"),this.$renderArea=this.$(".chart"),this.$toolbar=this.$(".btn-toolbar"),this.$fullsizeToggle=this.$(".fullsize"),this.$form=this.$(".editable");if(options&&options.editable===!1)return this.$form.detach(),this.$toolbar.detach();this.xAxis=new DataFieldDistribution({el:this.$el.find("[name=x-axis]"),collection:this.collection}),this.yAxis=new DataFieldDistribution({el:this.$el.find("[name=y-axis]"),collection:this.collection}),this.series=new DataFieldDistribution({el:this.$el.find("[name=series]"),enumerableOnly:!0,collection:this.collection});if(this.model)return this.model.get("xAxis")&&this.$form.hide(),(expanded=this.model.get("expanded"))?this.expand():this.contract()},DistributionChart.prototype.render=function(options){var labelText,_base;this.chart&&typeof (_base=this.chart).destroy=="function"&&_base.destroy(),this.$label.hide().detach(),this.$heading.text(options.title.text),options.title.text="";if(!options.series[0]){this.$renderArea.html("<h3 class=no-data>One or more of the selected                    dimensions does not contain any data. Please change your selection.</h3>");return}return this.$form.hide(),labelText=[],options.clustered&&labelText.push("Clustered"),labelText[0]&&(this.$label.text(labelText.join(", ")).show(),this.$heading.append(this.$label)),$.extend(!0,options,this.chartOptions),options.chart.renderTo=this.$renderArea[0],this.chart=new Highcharts.Chart(options),this},DistributionChart.prototype.disableRedundantFields=function(event){var $target,value;$target=$(event.target),this.xAxis.el===event.target?(this.yAxis.$("option").prop("disabled",!1),this.series.$("option").prop("disabled",!1)):this.yAxis.el===event.target?(this.xAxis.$("option").prop("disabled",!1),this.series.$("option").prop("disabled",!1)):(this.xAxis.$("option").prop("disabled",!1),this.yAxis.$("option").prop("disabled",!1));if((value=$target.val())!=="")return this.xAxis.el===event.target?(this.yAxis.$("option[value="+value+"]").prop("disabled",!0).val(""),this.series.$("option[value="+value+"]").prop("disabled",!0).val("")):this.yAxis.el===event.target?(this.xAxis.$("option[value="+value+"]").prop("disabled",!0).val(""),this.series.$("option[value="+value+"]").prop("disabled",!0).val("")):(this.xAxis.$("option[value="+value+"]").prop("disabled",!0).val(""),this.yAxis.$("option[value="+value+"]").prop("disabled",!0).val(""))},DistributionChart.prototype.toggleExpanded=function(event){var expanded;return expanded=this.model.get("expanded"),expanded?this.contract():this.expand(),this.model.save({expanded:!expanded})},DistributionChart.prototype.resize=function(){var chartWidth;chartWidth=this.$renderArea.width();if(this.chart)return this.chart.setSize(chartWidth,null,!1)},DistributionChart.prototype.expand=function(){return this.$fullsizeToggle.children("i").removeClass("icon-resize-small").addClass("icon-resize-full"),this.$el.addClass("expanded"),this.resize()},DistributionChart.prototype.contract=function(){return this.$fullsizeToggle.children("i").removeClass("icon-resize-full").addClass("icon-resize-small"),this.$el.removeClass("expanded"),this.resize()},DistributionChart.prototype.hideToolbar=function(){return this.$toolbar.fadeOut(200)},DistributionChart.prototype.showToolbar=function(){return this.$toolbar.fadeIn(200)},DistributionChart.prototype.toggleOutliers=function(event){var series,_i,_len,_ref,_results;_ref=this.chart.series,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){series=_ref[_i];continue}return _results},DistributionChart.prototype.toggleEdit=function(event){return this.$form.is(":visible")?this.$form.fadeOut(300):this.$form.fadeIn(300)},DistributionChart.prototype.removeChart=function(event){var _base;this.chart&&typeof (_base=this.chart).destroy=="function"&&_base.destroy(),this.$el.remove();if(this.model)return this.model.destroy()},DistributionChart.prototype.renderChart=function(url,data,fields,seriesIdx){var key,value,_ref,_this=this;if(this.options.data){_ref=this.options.data;for(key in _ref)value=_ref[key],data?data+="&"+key+"="+value:data=""+key+"="+value}return Backbone.ajax({url:url,data:data,success:function(resp){return _this.$renderArea.removeClass("loading"),_this.render(utils.processResponse(resp,fields,seriesIdx))}})},DistributionChart.prototype.updateChart=function(event){var _this=this;return event&&event.preventDefault(),this.collection.deferred.done(function(){var data,fields,series,seriesIdx,url,xAxis,yAxis;event==null&&((xAxis=_this.model.get("xAxis"))&&_this.xAxis.$el.val(xAxis.toString()),(yAxis=_this.model.get("yAxis"))&&_this.yAxis.$el.val(yAxis.toString()),(series=_this.model.get("series"))&&_this.series.$el.val(series.toString())),xAxis=_this.xAxis.getSelected(),yAxis=_this.yAxis.getSelected(),series=_this.series.getSelected();if(!xAxis)return;return _this.$renderArea.addClass("loading"),url=urlTmpl({id:xAxis.id}),fields=[xAxis],data="dimension="+xAxis.id,yAxis&&(fields.push(yAxis),data=data+"&dimension="+yAxis.id),series&&(seriesIdx=yAxis?2:1,data=data+"&dimension="+series.id),event&&_this.model&&_this.model.set({xAxis:xAxis.id,yAxis:yAxis?yAxis.id:void 0,series:series?series.id:void 0}),_this.renderChart(url,data,fields,seriesIdx)})},DistributionChart}(Backbone.Chart),{Distribution:DistributionChart}})