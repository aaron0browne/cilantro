/**!
 * project-site: http://plugins.jquery.com/project/AjaxManager
 * repository: http://github.com/aFarkas/Ajaxmanager
 * @author Alexander Farkas
 * @version 3.01
 * Copyright 2010, Alexander Farkas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

(function(c){var l={},m={};c.manageAjax=function(){function a(b,d){l[b]=new c.manageAjax._manager(b,d);return l[b]}return{create:a}}();c.manageAjax._manager=function(a,b){this.requests={};this.inProgress=0;this.qName=this.name=a;this.opts=c.extend({},c.ajaxSettings,c.manageAjax.defaults,b);if(b.queue&&b.queue!==true&&typeof b.queue==="string"&&b.queue!=="clear")this.qName=b.queue};c.manageAjax._manager.prototype={add:function(a){a=c.extend({},this.opts,a);var b=a.complete,d=a.success,g=a.beforeSend,
e=a.error,f=typeof a.data=="string"?a.data:c.param(a.data||{}),i=a.type+a.url+f,j=this,o=this._createAjax(i,a,d,b);if(!(this.requests[i]&&a.preventDoubbleRequests)){o.xhrID=i;a.xhrID=i;a.beforeSend=function(h,k){h=g.call(this,h,k);h===false&&j._removeXHR(i);return h};a.complete=function(h,k){j._complete.call(j,this,b,h,k,i,a)};a.success=function(h,k,n){j._success.call(j,this,d,h,k,n,a)};a.error=function(h,k,n){h=h||{};var p=h.status,q=h.responseXML||h.responseText;e?e.call(this,h,k,n,a):setTimeout(function(){throw k+
":: status: "+p+" | URL: "+a.url+" | data: "+f+" | thrown: "+n+" | response: "+q;},0);h=null};a.queue==="clear"&&c(document).clearQueue(this.qName);if(a.queue){c.queue(document,this.qName,o);this.inProgress<a.maxRequests&&c.dequeue(document,this.qName);return i}return o()}},_createAjax:function(a,b,d,g){var e=this;return function(){if(b.beforeCreate.call(b.context||e,a,b)!==false){e.inProgress++;if(b.cacheResponse&&m[a]){e.requests[a]={};setTimeout(function(){e._complete.call(e,b.context||b,g,{},
"success",a,b);e._success.call(e,b.context||b,d,m[a],"success",{},b)},0)}else e.requests[a]=c.ajax(b);e.inProgress===1&&c.event.trigger(e.name+"AjaxStart");return a}}},_removeXHR:function(a){this.opts.queue&&c.dequeue(document,this.qName);this.inProgress--;this.requests[a]=null;delete this.requests[a]},_isAbort:function(a,b){return!!(b.abortIsNoSuccess&&(!a||a.readyState===0||this.lastAbort===b.xhrID))},_complete:function(a,b,d,g,e,f){if(this._isAbort(d,f)){g="abort";f.abort.call(a,d,g,f)}b.call(a,
d,g,f);c.event.trigger(this.name+"AjaxComplete",[d,g,f]);f.domCompleteTrigger&&c(f.domCompleteTrigger).trigger(this.name+"DOMComplete",[d,g,f]).trigger("DOMComplete",[d,g,f]);this._removeXHR(e);this.inProgress||c.event.trigger(this.name+"AjaxStop")},_success:function(a,b,d,g,e,f){var i=this;if(!this._isAbort(e,f)){f.abortOld&&c.each(this.requests,function(j){if(j===f.xhrID)return false;i.abort(j)});if(f.cacheResponse&&!m[f.xhrID])m[f.xhrID]=d;b.call(a,d,g,e,f);c.event.trigger(this.name+"AjaxSuccess",
[e,f,d]);f.domSuccessTrigger&&c(f.domSuccessTrigger).trigger(this.name+"DOMSuccess",[d,f]).trigger("DOMSuccess",[d,f])}e=null},getData:function(a){if(a){var b=this.requests[a];if(!b&&this.opts.queue)b=c.grep(c(document).queue(this.qName),function(d){return d.xhrID===a})[0];return b}return{requests:this.requests,queue:this.opts.queue?c(document).queue(this.qName):[],inProgress:this.inProgress}},abort:function(a){var b;if(a){if((b=this.getData(a))&&b.abort){this.lastAbort=a;b.abort();this.lastAbort=
false}else c(document).queue(this.qName,c.grep(c(document).queue(this.qName),function(e){return e!==b}));b=null}else{var d=this,g=[];c.each(this.requests,function(e){g.push(e)});c.each(g,function(e,f){d.abort(f)})}},clear:function(a){c(document).clearQueue(this.qName);a&&this.abort()}};c.manageAjax._manager.prototype.getXHR=c.manageAjax._manager.prototype.getData;c.manageAjax.defaults={complete:c.noop,success:c.noop,beforeSend:c.noop,beforeCreate:c.noop,abort:c.noop,abortIsNoSuccess:true,maxRequests:1,
cacheResponse:false,domCompleteTrigger:false,domSuccessTrigger:false,preventDoubbleRequests:true,queue:false};c.each(c.manageAjax._manager.prototype,function(a,b){a.indexOf("_")===0||!c.isFunction(b)||(c.manageAjax[a]=function(d,g){if(!l[d])if(a==="add")c.manageAjax.create(d,g);else return;var e=Array.prototype.slice.call(arguments,1);l[d][a].apply(l[d],e)})})})(jQuery);
