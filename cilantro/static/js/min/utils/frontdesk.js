define(function(){function a(a){function d(){var a=0;for(var b in i)i[b]==="in"&&a++;return a+e}function c(a,b,c){var d=j[a];typeof b=="function"?b.apply(b,c):(typeof b=="string"||b instanceof String)&&d[b].apply(d,c)}function b(a){if(a&&typeof a=="object"&&typeof a.length=="number"&&!a.propertyIsEnumerable("length"))return!0;return!1}var e=0,f=[],g=[],h={},i={},j={},k=null,l=b(a);this.onEmpty=function(a){f.push(a)},this.onFull=function(a){g.push(a)},this.checkIn=function(b,c){var f,k=!1;if(b!==undefined){if(i[b]!=="in"){h[b]=[],i[b]="in",c!==undefined&&(j[b]=c),k=!0;if(l)for(f in a)if(i[f]!=="in"){k=!1;break}}}else e++;(d()===a||k)&&$.each(g,function(a,b){b()});return c},this.checkOut=function(a,b){if(d()!==0){if(a===undefined)e--;else if(i[a]==="in"){i[a]="out",b!==undefined&&(j[a]=b);for(var g=0,k=h[a].length;g<k;g++)c(a,h[a][g][0],h[a][g][1])}d()===0&&$.each(f,function(a,b){b()})}},this.leaveMessage=function(a,b){var d=Array.prototype.slice.call(arguments,2);i[a]==="in"?h[a].push([b,d]):c(a,b,d)}}return a})