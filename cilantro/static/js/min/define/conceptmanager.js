define(["cilantro/define/view"],function(a){function t(a,b,c,d){v.fadeIn(),parseInt(a.id,10)!==D&&(b&&(a.query=b),D!==null&&(A[D]["static"]=z.children().detach()),A[a.id]&&A[a.id].globalsLoaded?q(a):p(a,q))}function s(a){A[a.id]===undefined?A[a.id]=a:($.extend(A[a.id],a),a=A[a.id]),a.ds||(a.query?a.ds=f(a.query):a.ds={}),a.invalid_fields||(a.invalid_fields={});return a}function r(a,b){var c=x.children().index(b);x.trigger("ShowViewEvent",c)}function q(a){a=s(a),D=parseInt(a.id,10),a.globalsLoaded=!0,a.views.length<2?x.hide():x.show();var b=$.jqote(B,a.views);x.html(b),a["static"]?(z.append(a["static"]),F=z.find("#add_to_query")):(z.append(C),F=z.find("#add_to_query"),F.click(function(){var a=$.Event("UpdateQueryButtonClicked");$(this).trigger(a);return!1})),$.inArray(D,G)<0?(F.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",z).hide()):(F.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",z).show()),x.children(":first").click()}function p(b,c){c=c||function(){},b.css&&a.loadCss(b.css),b.js?require([b.js],function(a){c(b)}):c(b)}function o(a){a.reason=a.reason?"_"+a.reason:"";var b=A[D].invalid_fields,c=$(a.target).attr("name");$.each(A[D].views,function(b,d){d.contents&&d.contents.dom().find("[name="+c+"]").removeClass("invalid"+a.reason),d.contents&&d.contents.dom().find("[name="+c+"]").children().removeClass("invalid"+a.reason)});var d=b[c+a.reason].data("ref_count")-1;d===0?b[c+a.reason].remove():b[c+a.reason].data("ref_count",d),delete A[D].invalid_fields[c+a.reason],$.isEmptyObject(A[D].invalid_fields)&&z.find("#add_to_query").attr("disabled","")}function n(a){a.reason=a.reason?"_"+a.reason:"";var b=A[D].invalid_fields,c=$(a.target).attr("name");$.each(A[D].views,function(b,d){d.contents&&d.contents.dom().find("[name="+c+"]").addClass("invalid"+a.reason),d.contents&&d.contents.dom().find("[name="+c+"]").children().addClass("invalid"+a.reason)});var d=a.message?a.message:"This query contains invalid input, please correct any invalid fields.",e=!1;$.each(z.find(".error"),function(f,g){g=$(g);var h=g.data("ref_count");if(g.text()===d){e=!0;if(a.ephemeral)return;if(b[c+a.reason]===undefined)b[c+a.reason]=g,g.data("ref_count",h+1);else if(g.text()!==b[c+a.reason].text()){var i=b[c+a.reason].data("ref_count");b[c+a.reason].data("ref_count",i-1),b[c+a.reason].data("ref_count")===0&&b[c+a.reason].remove(),b[c+a.reason]=g,g.data("ref_count",h+1)}}});if(!e){var f=$('<div class="message error">'+d+"</div>");f.data("ref_count",1),a.ephemeral||(b[c+a.reason]=f),z.prepend(f),a.ephemeral?f.fadeOut(3e3,function(){f.remove()}):z.find("#add_to_query").attr("disabled","true")}}function m(a){$(E.contents).triggerHandler("UpdateQueryButtonClicked")}function l(a,b){b=b||A[D].ds;if(!k(b)){var c=$.Event("InvalidInputEvent");c.ephemeral=!0,c.message="No value has been specified.",$(a.target).trigger(c);return!1}var d=e(b);$(a.target).trigger("UpdateQueryEvent",[d]);return!0}function k(a){var b=!1;if($.isEmptyObject(a))b=!0;else{b=!0;for(var c in a){if(!a.hasOwnProperty(c))continue;if(J.test(c)){if(a[c]&&a[c].indexOf("isnull")>=0){b=!1;break}}else if(K.test(c)||I.test(c)||H.test(c)){b=!1;break}}}if(b)return!1;for(var c in a){if(!a.hasOwnProperty(c))continue;if(a[c]===undefined||a[c]==="")return!1;if($.isArray(a[c])&&a[c].length===0)return!1}return!0}function j(a,b){var c=A[D].ds,d=!1;if(b.value instanceof Array||c[b.name]!==b.value){if(b.value instanceof Array&&c[b.name]instanceof Array){for(var e=0;e<b.value.length;e++)if($.inArray(b.value[e],c[b.name])==-1){d=!0;break}if(d===!1&&b.value.length==c[b.name].length)return}b.value===undefined?delete A[D].ds[b.name]:A[D].ds[b.name]=b.value instanceof Array?b.value.slice(0):b.value,$.each(A[D].views,function(a,c){E!==c&&c.contents&&c.contents.trigger("UpdateElementEvent",[b])})}}function i(a,b){}function h(b,c){E!==null&&(E.contents.dom().css("display","none"),$(E.contents).trigger("LostFocusEvent"),E.contents.dom().detach()),E=A[D].views[c];if(E.loaded)g(null,E.contents);else{var d=null;E.concept_id=D,v.fadeIn().trigger("ViewReadyEvent",[new a(E,A[D].name)])}}function g(a,b){E.contents=b;var c=E.contents.dom();y.append(c),c.css("display","block"),$(".chart",E.contents).css("display","block"),E.loaded||($(b).trigger("UpdateDSEvent",[A[D].ds]),$(b).trigger("RegisterElementsEvent")),$(b).trigger("GainedFocusEvent"),E.loaded=!0}function f(a,b){var c=b||{},d,e;if(a.hasOwnProperty("type"))$.each(a.children,function(a,b){f(b,c)});else{a.hasOwnProperty("id_choices")?(e=a.id_choices.join("OR"),c[e]=a.id):e=a.id,d=a.concept_id+"_"+e;if(!a.operator.match(/null/))if(a.datatype in{number:1,date:1}){var g=a.value instanceof Array?a.value:[a.value];for(var h=0;h<g.length;h++)c[d+"_input"+h]=g[h]}else c.hasOwnProperty(d)?c[d]instanceof Array?c[d].push(a.value):(c[d]=[c[d]],c[d].push(a.value)):c[d]=a.value;c[d+"_operator"]=c[d]instanceof Array&&a.datatype&&a.datatype.indexOf("boolean")>=0?N[a.operator]:a.operator}return c}function e(a){var b={};for(var c in a){if(!a.hasOwnProperty(c))continue;var e=I.exec(c);if(e){b.hasOwnProperty(e[2])?$.extend(b[e[2]],{val0:a[c],val1:undefined,op:undefined}):b[e[2]]={val0:a[c],val1:undefined,op:undefined};continue}e=H.exec(c);if(e){b.hasOwnProperty(e[2])?b[e[2]]["val"+e[3]]=Number(a[c])||a[c]:(b[e[2]]={val0:undefined,val1:undefined,op:undefined},b[e[2]]["val"+e[3]]=Number(a[c])||a[c]);continue}e=K.exec(c),e&&(b.hasOwnProperty(e[0])?b[e[0]].pk=a[c]:b[e[0]]={val0:undefined,val1:undefined,op:undefined,pk:a[c]})}for(c in a){if(!a.hasOwnProperty(c))continue;e=J.exec(c),e&&(b[e[2]]||a[c].match(/null/))&&(b.hasOwnProperty(e[2])||(b[e[2]]={val0:undefined,val1:undefined,op:undefined}),b[e[2]].op=a[c])}var f=[];for(var g in b){var h=b[g],i=!1,j=null;K.exec(g)&&(j=g.split("OR"),g=h.pk,i=!0),g=Number(g);if(h.val0===undefined&&h.val1===undefined&&h.op!==undefined)f.push({operator:h.op,id:g,concept_id:D,value:!0,datatype:d(g)});else if(h.val0!==undefined&&h.val1!==undefined&&h.op!==undefined)f.push({operator:h.op,id:g,value:[h.val0,h.val1],concept_id:D,datatype:d(g)});else if(h.val0===undefined||h.op===undefined||h.val0 instanceof Array)if(h.val0!==undefined&&h.val0 instanceof Array){h.op=h.op!==undefined?h.op:"in";var k=d(g);switch(k){case"boolean":case"nullboolean":var l=[],m=M[h.op];$.each(h.val0,function(a,b){l.push({operator:m,id:g,value:O[b]!==undefined?O[b]:b,concept_id:D,datatype:k})}),l.length>1?f.push({type:L.test(h.op)?"and":"or",children:l,concept_id:D}):f.push(l[0]);break;default:f.push({operator:h.op,id:g,value:h.val0,concept_id:D})}}else{if(h.val0===undefined||h.val0 instanceof Array||h.val1!==undefined)throw"Unable to determine field "+h+" in concept "+D;f.push({operator:"exact",id:g,value:h.val0,concept_id:D})}else f.push({operator:h.op,id:g,value:h.val0,concept_id:D,datatype:d(g)});i&&(f[f.length-1].id_choices=j)}var n;f.length===1?n=f[0]:n={type:E.join_by||"and",children:f,concept_id:D};return n}function d(a){var b=E.elements,c=null;$.each(b,function(b,d){if(d.type==="custom")return d.datatype;if(d.data){if(d.data.pk==a){c=d.data.datatype;return!1}if(d.data.pkchoices&&$.inArray(a,$.map(d.data.pkchoices,function(a,b){return a[0]}))>=0){c=d.data.datatype;return!1}}else{$.each(d.fields,function(b,d){if(d.pk==a){c=d.datatype;return!1}if(d.pkchoices&&$.inArray(a,$.map(d.pkchoices,function(a,b){return a[0]}))>=0){c=d.datatype;return!1}});if(c!==null)return!1}});return c}function c(a){var b=$.inArray(parseInt(a.concept_id,10),G);b>=0&&(G.splice(b,1),D===parseInt(a.concept_id,10)&&(F.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",z).hide())),a.stopPropagation()}function b(a){$.inArray(a.concept_id,G)<0&&(G.push(parseInt(a.concept_id,10)),D===parseInt(a.concept_id,10)&&(F.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",z).show())),a.stopPropagation()}var u={},v=$("#plugin-panel"),w=$("#plugin-title"),x=$("#plugin-tabs"),y=$("#plugin-dynamic-content"),z=$("#plugin-static-content"),A={},B='<a class="tab" href="#"><%= this.tabname %></a> ',C=['<div class="message success">Condition has been added.</div>','<button id="add_to_query"></button>'].join(""),D=null,E=null,F=null,G=[],H=/^(\d+)_(\d+(?:OR\d+)*)_input([01])$/,I=/^(\d*)_(\d+(?:OR\d+)*)$/,J=/^(\d*)_(\d+(?:OR\d+)*)_operator$/,K=/^\d+(?:OR\d+)+$/,L=/-/,M={"in":"exact","-in":"-exact",exact:"exact","-exact":"-exact"},N={exact:"in","-exact":"-in"},O={"true":!0,"false":!1,"null":null};v.bind({ViewReadyEvent:g,ViewErrorEvent:i,ShowViewEvent:h,ElementChangedEvent:j,UpdateQueryButtonClicked:m,InvalidInputEvent:n,InputCorrectedEvent:o,ConstructQueryEvent:l,ConceptDeletedEvent:c,ConceptAddedEvent:b}),x.bind("ConceptTabClickedEvent",r),x.tabs(!0,function(a,b){b.trigger("ConceptTabClickedEvent",b)});return{show:t,isConceptLoaded:function(a){return a in A},buildQuery:e,constructQueryHandler:l}})