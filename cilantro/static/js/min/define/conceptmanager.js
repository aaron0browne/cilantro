define(["cilantro/define/view"],function(a){var b;$(function(){var c=$("#plugin-panel"),d=$("#plugin-title"),e=$("#plugin-tabs"),f=$("#plugin-dynamic-content"),g=$("#plugin-static-content");b=function(){function M(a,c,d,e){parseInt(a.id)!==i&&(c&&(a.query=c),i!==null&&(b[i]["static"]=g.children().detach()),b[a.id]&&b[a.id].globalsLoaded?J(a):I(a,J))}function L(a){b[a.id]===undefined?b[a.id]=a:($.extend(b[a.id],a),a=b[a.id]),a.ds||(a.query?a.ds=y(a.query):a.ds={}),a.invalid_fields||(a.invalid_fields={});return a}function K(a,b){var c=e.children().index(b);e.trigger("ShowViewEvent",c)}function J(a){a=L(a),i=parseInt(a.id),a.globalsLoaded=!0,a.views.length<2?e.hide():e.show();var b=$.jqote(d,a.views);e.html(b),a["static"]?(g.append(a["static"]),k=g.find("#add_to_query")):(g.append(h),k=g.find("#add_to_query"),k.click(function(){var a=$.Event("UpdateQueryButtonClicked");$(this).trigger(a);return!1})),$.inArray(i,l)<0?(k.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",g).hide()):(k.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",g).show()),e.children(":first").click()}function I(b,c){c=c||function(){},b.css&&a.loadCss(b.css),b.js?require([b.js],function(a){c(b)}):c(b)}function H(a){a.reason=a.reason?"_"+a.reason:"";var c=b[i].invalid_fields,d=$(a.target).attr("name");$.each(b[i].views,function(b,c){c.contents&&c.contents.dom().find("[name="+d+"]").removeClass("invalid"+a.reason),c.contents&&c.contents.dom().find("[name="+d+"]").children().removeClass("invalid"+a.reason)});var e=c[d+a.reason].data("ref_count")-1;e===0?c[d+a.reason].remove():c[d+a.reason].data("ref_count",e),delete b[i].invalid_fields[d+a.reason],$.isEmptyObject(b[i].invalid_fields)&&g.find("#add_to_query").attr("disabled","")}function G(a){a.reason=a.reason?"_"+a.reason:"";var c=b[i].invalid_fields,d=$(a.target).attr("name");$.each(b[i].views,function(b,c){c.contents&&c.contents.dom().find("[name="+d+"]").addClass("invalid"+a.reason),c.contents&&c.contents.dom().find("[name="+d+"]").children().addClass("invalid"+a.reason)});var e=a.message?a.message:"This query contains invalid input, please correct any invalid fields.",f=!1;$.each(g.find(".error"),function(b,g){g=$(g);var h=g.data("ref_count");if(g.text()===e){f=!0;if(a.ephemeral)return;if(c[d+a.reason]===undefined)c[d+a.reason]=g,g.data("ref_count",h+1);else if(g.text()!==c[d+a.reason].text()){var i=c[d+a.reason].data("ref_count");c[d+a.reason].data("ref_count",i-1),c[d+a.reason].data("ref_count")===0&&c[d+a.reason].remove(),c[d+a.reason]=g,g.data("ref_count",h+1)}}});if(!f){var h=$('<div class="message error">'+e+"</div>");h.data("ref_count",1),a.ephemeral||(c[d+a.reason]=h),g.prepend(h),a.ephemeral?h.fadeOut(3e3,function(){h.remove()}):g.find("#add_to_query").attr("disabled","true")}}function F(a){$(j.contents).triggerHandler("UpdateQueryButtonClicked")}function E(a,c){c=c||b[i].ds;if(!D(c)){var d=$.Event("InvalidInputEvent");d.ephemeral=!0,d.message="No value has been specified.",$(a.target).trigger(d);return!1}var e=x(c);$(a.target).trigger("UpdateQueryEvent",[e]);return!0}function D(a){var b=!1;if($.isEmptyObject(a))b=!0;else{b=!0;for(var c in a){if(!a.hasOwnProperty(c))continue;if(o.test(c)){if(a[c]&&a[c].indexOf("isnull")>=0){b=!1;break}}else if(p.test(c)||n.test(c)||m.test(c)){b=!1;break}}}if(b)return!1;for(var c in a){if(!a.hasOwnProperty(c))continue;if(a[c]===undefined||a[c]==="")return!1;if($.isArray(a[c])&&a[c].length===0)return!1}return!0}function C(a,c){var d=b[i].ds,e=!1;if(c.value instanceof Array||d[c.name]!==c.value){if(c.value instanceof Array&&d[c.name]instanceof Array){for(var f=0;f<c.value.length;f++)if($.inArray(c.value[f],d[c.name])==-1){e=!0;break}if(e===!1&&c.value.length==d[c.name].length)return}c.value===undefined?delete b[i].ds[c.name]:b[i].ds[c.name]=c.value instanceof Array?c.value.slice(0):c.value,$.each(b[i].views,function(a,b){j!==b&&b.contents&&b.contents.trigger("UpdateElementEvent",[c])})}}function B(a,b){}function A(d,e){j!==null&&(j.contents.dom().css("display","none"),$(j.contents).trigger("LostFocusEvent"),j.contents.dom().detach()),j=b[i].views[e];if(j.loaded)z(null,j.contents);else{var f=null;j.concept_id=i,c.trigger("ViewReadyEvent",[new a(j,b[i].name)])}}function z(a,c){j.contents=c;var d=j.contents.dom();f.append(d),d.css("display","block"),$(".chart",j.contents).css("display","block"),j.loaded||($(c).trigger("UpdateDSEvent",[b[i].ds]),$(c).trigger("RegisterElementsEvent")),$(c).trigger("GainedFocusEvent"),j.loaded=!0}function y(a,b){var c=b||{},d,e;if(a.hasOwnProperty("type"))$.each(a.children,function(a,b){y(b,c)});else{a.hasOwnProperty("id_choices")?(e=a.id_choices.join("OR"),c[e]=a.id):e=a.id,d=a.concept_id+"_"+e;if(!a.operator.match(/null/))if(a.datatype in{number:1,date:1}){var f=a.value instanceof Array?a.value:[a.value];for(var g=0;g<f.length;g++)c[d+"_input"+g]=f[g]}else c.hasOwnProperty(d)?c[d]instanceof Array?c[d].push(a.value):(c[d]=[c[d]],c[d].push(a.value)):c[d]=a.value;c[d+"_operator"]=c[d]instanceof Array&&a.datatype&&a.datatype.indexOf("boolean")>=0?s[a.operator]:a.operator}return c}function x(a){var b={};for(var c in a){if(!a.hasOwnProperty(c))continue;var d=n.exec(c);if(d){b.hasOwnProperty(d[2])?$.extend(b[d[2]],{val0:a[c],val1:undefined,op:undefined}):b[d[2]]={val0:a[c],val1:undefined,op:undefined};continue}d=m.exec(c);if(d){b.hasOwnProperty(d[2])?b[d[2]]["val"+d[3]]=Number(a[c])||a[c]:(b[d[2]]={val0:undefined,val1:undefined,op:undefined},b[d[2]]["val"+d[3]]=Number(a[c])||a[c]);continue}d=p.exec(c),d&&(b.hasOwnProperty(d[0])?b[d[0]].pk=a[c]:b[d[0]]={val0:undefined,val1:undefined,op:undefined,pk:a[c]})}for(c in a){if(!a.hasOwnProperty(c))continue;d=o.exec(c),d&&(b[d[2]]||a[c].match(/null/))&&(b.hasOwnProperty(d[2])||(b[d[2]]={val0:undefined,val1:undefined,op:undefined}),b[d[2]].op=a[c])}var e=[];for(var f in b){var g=b[f],h=!1,k=null;p.exec(f)&&(k=f.split("OR"),f=g.pk,h=!0),f=Number(f);if(g.val0===undefined&&g.val1===undefined&&g.op!==undefined)e.push({operator:g.op,id:f,concept_id:i,value:!0,datatype:w(f)});else if(g.val0!==undefined&&g.val1!==undefined&&g.op!==undefined)e.push({operator:g.op,id:f,value:[g.val0,g.val1],concept_id:i,datatype:w(f)});else if(g.val0===undefined||g.op===undefined||g.val0 instanceof Array)if(g.val0!==undefined&&g.val0 instanceof Array){g.op=g.op!==undefined?g.op:"in";var l=w(f);switch(l){case"boolean":case"nullboolean":var s=[],u=r[g.op];$.each(g.val0,function(a,b){s.push({operator:u,id:f,value:t[b]!==undefined?t[b]:b,concept_id:i,datatype:l})}),s.length>1?e.push({type:q.test(g.op)?"and":"or",children:s,concept_id:i}):e.push(s[0]);break;default:e.push({operator:g.op,id:f,value:g.val0,concept_id:i})}}else{if(g.val0===undefined||g.val0 instanceof Array||g.val1!==undefined)throw"Unable to determine field "+g+" in concept "+i;e.push({operator:"exact",id:f,value:g.val0,concept_id:i})}else e.push({operator:g.op,id:f,value:g.val0,concept_id:i,datatype:w(f)});h&&(e[e.length-1].id_choices=k)}var v;e.length===1?v=e[0]:v={type:j.join_by||"and",children:e,concept_id:i};return v}function w(a){var b=j.elements,c=null;$.each(b,function(b,d){if(d.type==="custom")return d.datatype;if(d.data){if(d.data.pk==a){c=d.data.datatype;return!1}if(d.data.pkchoices&&$.inArray(a,$.map(d.data.pkchoices,function(a,b){return a[0]}))>=0){c=d.data.datatype;return!1}}else{$.each(d.fields,function(b,d){if(d.pk==a){c=d.datatype;return!1}if(d.pkchoices&&$.inArray(a,$.map(d.pkchoices,function(a,b){return a[0]}))>=0){c=d.datatype;return!1}});if(c!==null)return!1}});return c}function v(a){var b=$.inArray(parseInt(a.concept_id),l);b>=0&&(l.splice(b,1),i===parseInt(a.concept_id)&&(k.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",g).hide())),a.stopPropagation()}function u(a){$.inArray(a.concept_id,l)<0&&(l.push(parseInt(a.concept_id)),i===parseInt(a.concept_id)&&(k.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",g).show())),a.stopPropagation()}var b={},d='<a class="tab" href="#"><%= this.tabname %></a> ',h=['<div class="message success">Condition has been added.</div>','<button id="add_to_query"></button>'].join(""),i=null,j=null,k=null,l=[],m=/^(\d+)_(\d+(?:OR\d+)*)_input([01])$/,n=/^(\d*)_(\d+(?:OR\d+)*)$/,o=/^(\d*)_(\d+(?:OR\d+)*)_operator$/,p=/^\d+(?:OR\d+)+$/,q=/-/,r={"in":"exact","-in":"-exact",exact:"exact","-exact":"-exact"},s={exact:"in","-exact":"-in"},t={"true":!0,"false":!1,"null":null};c.bind({ViewReadyEvent:z,ViewErrorEvent:B,ShowViewEvent:A,ElementChangedEvent:C,UpdateQueryButtonClicked:F,InvalidInputEvent:G,InputCorrectedEvent:H,ConstructQueryEvent:E,ConceptDeletedEvent:v,ConceptAddedEvent:u}),e.bind("ConceptTabClickedEvent",K),e.tabs(!0,function(a,b){b.trigger("ConceptTabClickedEvent",b)});return{show:M,isConceptLoaded:function(a){return a in b},buildQuery:x,constructQueryHandler:E}}()});return b})