define(["cilantro/define/view"],function(a){function t(a){$.inArray(a.concept_id,G)<0&&(G.push(parseInt(a.concept_id,10)),D===parseInt(a.concept_id,10)&&(F.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",z).show())),a.stopPropagation()}function s(a){var b=$.inArray(parseInt(a.concept_id,10),G);b>=0&&(G.splice(b,1),D===parseInt(a.concept_id,10)&&(F.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",z).hide())),a.stopPropagation()}function r(a){var b=E.elements,c=null;$.each(b,function(b,d){if(d.type==="custom")return d.datatype;if(d.data){if(d.data.pk==a){c=d.data.datatype;return!1}if(d.data.pkchoices&&$.inArray(a,$.map(d.data.pkchoices,function(a,b){return a[0]}))>=0){c=d.data.datatype;return!1}}else{$.each(d.fields,function(b,d){if(d.pk==a){c=d.datatype;return!1}if(d.pkchoices&&$.inArray(a,$.map(d.pkchoices,function(a,b){return a[0]}))>=0){c=d.datatype;return!1}});if(c!==null)return!1}});return c}function q(a){var b={};for(var c in a){if(!a.hasOwnProperty(c))continue;var d=I.exec(c);if(d){b.hasOwnProperty(d[2])?$.extend(b[d[2]],{val0:a[c],val1:undefined,op:undefined}):b[d[2]]={val0:a[c],val1:undefined,op:undefined};continue}d=H.exec(c);if(d){b.hasOwnProperty(d[2])?b[d[2]]["val"+d[3]]=Number(a[c])||a[c]:(b[d[2]]={val0:undefined,val1:undefined,op:undefined},b[d[2]]["val"+d[3]]=Number(a[c])||a[c]);continue}d=K.exec(c),d&&(b.hasOwnProperty(d[0])?b[d[0]].pk=a[c]:b[d[0]]={val0:undefined,val1:undefined,op:undefined,pk:a[c]})}for(c in a){if(!a.hasOwnProperty(c))continue;d=J.exec(c),d&&(b[d[2]]||a[c].match(/null/))&&(b.hasOwnProperty(d[2])||(b[d[2]]={val0:undefined,val1:undefined,op:undefined}),b[d[2]].op=a[c])}var e=[];for(var f in b){var g=b[f],h=!1,i=null;K.exec(f)&&(i=f.split("OR"),f=g.pk,h=!0),f=Number(f);if(g.val0===undefined&&g.val1===undefined&&g.op!==undefined)e.push({operator:g.op,id:f,concept_id:D,value:!0,datatype:r(f)});else if(g.val0!==undefined&&g.val1!==undefined&&g.op!==undefined)e.push({operator:g.op,id:f,value:[g.val0,g.val1],concept_id:D,datatype:r(f)});else if(g.val0===undefined||g.op===undefined||g.val0 instanceof Array)if(g.val0!==undefined&&g.val0 instanceof Array){g.op=g.op!==undefined?g.op:"in";var j=r(f);switch(j){case"boolean":case"nullboolean":var k=[],l=M[g.op];$.each(g.val0,function(a,b){k.push({operator:l,id:f,value:O[b]!==undefined?O[b]:b,concept_id:D,datatype:j})}),k.length>1?e.push({type:L.test(g.op)?"and":"or",children:k,concept_id:D}):e.push(k[0]);break;default:e.push({operator:g.op,id:f,value:g.val0,concept_id:D})}}else{if(g.val0===undefined||g.val0 instanceof Array||g.val1!==undefined)throw"Unable to determine field "+g+" in concept "+D;e.push({operator:"exact",id:f,value:g.val0,concept_id:D})}else e.push({operator:g.op,id:f,value:g.val0,concept_id:D,datatype:r(f)});h&&(e[e.length-1].id_choices=i)}var m;e.length===1?m=e[0]:m={type:E.join_by||"and",children:e,concept_id:D};return m}function p(a,b){var c=b||{},d,e;if(a.hasOwnProperty("type"))$.each(a.children,function(a,b){p(b,c)});else{a.hasOwnProperty("id_choices")?(e=a.id_choices.join("OR"),c[e]=a.id):e=a.id,d=a.concept_id+"_"+e;if(!a.operator.match(/null/))if(a.datatype in{number:1,date:1}){var f=a.value instanceof Array?a.value:[a.value];for(var g=0;g<f.length;g++)c[d+"_input"+g]=f[g]}else c.hasOwnProperty(d)?c[d]instanceof Array?c[d].push(a.value):(c[d]=[c[d]],c[d].push(a.value)):c[d]=a.value;c[d+"_operator"]=c[d]instanceof Array&&a.datatype&&a.datatype.indexOf("boolean")>=0?N[a.operator]:a.operator}return c}function o(a,b){E.contents=b;var c=E.contents.dom();y.append(c),c.css("display","block"),$(".chart",E.contents).css("display","block"),E.loaded||($(b).trigger("UpdateDSEvent",[A[D].ds]),$(b).trigger("RegisterElementsEvent")),$(b).trigger("GainedFocusEvent"),E.loaded=!0}function n(b,c){E!==null&&(E.contents.dom().css("display","none"),$(E.contents).trigger("LostFocusEvent"),E.contents.dom().detach()),E=A[D].views[c];if(E.loaded)o(null,E.contents);else{var d=null;E.concept_id=D,v.fadeIn().trigger("ViewReadyEvent",[new a(E,A[D].name)])}}function m(a,b){}function l(a,b){var c=A[D].ds,d=!1;if(b.value instanceof Array||c[b.name]!==b.value){if(b.value instanceof Array&&c[b.name]instanceof Array){for(var e=0;e<b.value.length;e++)if($.inArray(b.value[e],c[b.name])==-1){d=!0;break}if(d===!1&&b.value.length==c[b.name].length)return}b.value===undefined?delete A[D].ds[b.name]:A[D].ds[b.name]=b.value instanceof Array?b.value.slice(0):b.value,$.each(A[D].views,function(a,c){E!==c&&c.contents&&c.contents.trigger("UpdateElementEvent",[b])})}}function k(a){var b=!1;if($.isEmptyObject(a))b=!0;else{b=!0;for(var c in a){if(!a.hasOwnProperty(c))continue;if(J.test(c)){if(a[c]&&a[c].indexOf("isnull")>=0){b=!1;break}}else if(K.test(c)||I.test(c)||H.test(c)){b=!1;break}}}if(b)return!1;for(var c in a){if(!a.hasOwnProperty(c))continue;if(a[c]===undefined||a[c]==="")return!1;if($.isArray(a[c])&&a[c].length===0)return!1}return!0}function j(a,b){b=b||A[D].ds;if(!k(b)){var c=$.Event("InvalidInputEvent");c.ephemeral=!0,c.message="No value has been specified.",$(a.target).trigger(c);return!1}var d=q(b);$(a.target).trigger("UpdateQueryEvent",[d]);return!0}function i(a){$(E.contents).triggerHandler("UpdateQueryButtonClicked")}function h(a){a.reason=a.reason?"_"+a.reason:"";var b=A[D].invalid_fields,c=$(a.target).attr("name");$.each(A[D].views,function(b,d){d.contents&&d.contents.dom().find("[name="+c+"]").addClass("invalid"+a.reason),d.contents&&d.contents.dom().find("[name="+c+"]").children().addClass("invalid"+a.reason)});var d=a.message?a.message:"This query contains invalid input, please correct any invalid fields.",e=!1;$.each(z.find(".error"),function(f,g){g=$(g);var h=g.data("ref_count");if(g.text()===d){e=!0;if(a.ephemeral)return;if(b[c+a.reason]===undefined)b[c+a.reason]=g,g.data("ref_count",h+1);else if(g.text()!==b[c+a.reason].text()){var i=b[c+a.reason].data("ref_count");b[c+a.reason].data("ref_count",i-1),b[c+a.reason].data("ref_count")===0&&b[c+a.reason].remove(),b[c+a.reason]=g,g.data("ref_count",h+1)}}});if(!e){var f=$('<div class="message error">'+d+"</div>");f.data("ref_count",1),a.ephemeral||(b[c+a.reason]=f),z.prepend(f),a.ephemeral?f.fadeOut(3e3,function(){f.remove()}):z.find("#add_to_query").attr("disabled","true")}}function g(a){a.reason=a.reason?"_"+a.reason:"";var b=A[D].invalid_fields,c=$(a.target).attr("name");$.each(A[D].views,function(b,d){d.contents&&d.contents.dom().find("[name="+c+"]").removeClass("invalid"+a.reason),d.contents&&d.contents.dom().find("[name="+c+"]").children().removeClass("invalid"+a.reason)});var d=b[c+a.reason].data("ref_count")-1;d===0?b[c+a.reason].remove():b[c+a.reason].data("ref_count",d),delete A[D].invalid_fields[c+a.reason],$.isEmptyObject(A[D].invalid_fields)&&z.find("#add_to_query").attr("disabled","")}function f(b,c){c=c||function(){},b.css&&a.loadCss(b.css),b.js?require([b.js],function(a){c(b)}):c(b)}function e(a){a=c(a),D=parseInt(a.id,10),a.globalsLoaded=!0,a.views.length<2?x.hide():x.show();var b=$.jqote(B,a.views);x.html(b),a["static"]?(z.append(a["static"]),F=z.find("#add_to_query")):(z.append(C),F=z.find("#add_to_query"),F.click(function(){var a=$.Event("UpdateQueryButtonClicked");$(this).trigger(a);return!1})),$.inArray(D,G)<0?(F.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",z).hide()):(F.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",z).show()),x.children(":first").click()}function d(a,b){var c=x.children().index(b);x.trigger("ShowViewEvent",c)}function c(a){A[a.id]===undefined?A[a.id]=a:($.extend(A[a.id],a),a=A[a.id]),a.ds||(a.query?a.ds=p(a.query):a.ds={}),a.invalid_fields||(a.invalid_fields={});return a}function b(a,b,c,d){v.fadeIn(),parseInt(a.id,10)!==D&&(b&&(a.query=b),D!==null&&(A[D]["static"]=z.children().detach()),A[a.id]&&A[a.id].globalsLoaded?e(a):f(a,e))}var u={},v=$("#plugin-panel"),w=$("#plugin-title"),x=$("#plugin-tabs"),y=$("#plugin-dynamic-content"),z=$("#plugin-static-content"),A={},B='<a class="tab" href="#"><%= this.tabname %></a> ',C=['<div class="message success">Condition has been added.</div>','<button id="add_to_query"></button>'].join(""),D=null,E=null,F=null,G=[],H=/^(\d+)_(\d+(?:OR\d+)*)_input([01])$/,I=/^(\d*)_(\d+(?:OR\d+)*)$/,J=/^(\d*)_(\d+(?:OR\d+)*)_operator$/,K=/^\d+(?:OR\d+)+$/,L=/-/,M={"in":"exact","-in":"-exact",exact:"exact","-exact":"-exact"},N={exact:"in","-exact":"-in"},O={"true":!0,"false":!1,"null":null};v.bind({ViewReadyEvent:o,ViewErrorEvent:m,ShowViewEvent:n,ElementChangedEvent:l,UpdateQueryButtonClicked:i,InvalidInputEvent:h,InputCorrectedEvent:g,ConstructQueryEvent:j,ConceptDeletedEvent:s,ConceptAddedEvent:t}),x.bind("ConceptTabClickedEvent",d),x.tabs(!0,function(a,b){b.trigger("ConceptTabClickedEvent",b)});return{show:b,isConceptLoaded:function(a){return a in A},buildQuery:q,constructQueryHandler:j}})