define(["cilantro/define/criteria"],function(a){var b='<button id="submit-query"><span class="icon arrow-r"/> <span>Get Report</span></button>',c;$(function(){var d=$("#user-criteria");c=function(){var c={},e=d.find("#criteria-list"),f=d.find(".content"),g=d.find("#remove-criteria"),h=e.attr("data-uri"),i=e.attr("data-report"),j=d.attr("data-uri"),k=e.children(),l=$(b);$.getJSON(j,function(a){a.store!==null&&!$.isEmptyObject(a.store)&&(a.store.hasOwnProperty("concept_id")?d.triggerHandler("UpdateQueryEvent",[a.store,!0]):$.each(a.store.children.reverse(),function(a,b){d.triggerHandler("UpdateQueryEvent",[b,!0])}))}),l.click(function(){var a=[],b;for(var d in c)c.hasOwnProperty(d)&&a.push(c[d].data("constraint"));a.length<2?b=a[0]:b={type:"and",children:a},$.putJSON(j,JSON.stringify(b),function(){window.location=i})}),g.click(function(){for(var a in c)c.hasOwnProperty(a)&&c[a].trigger("CriteriaRemovedEvent")}),d.bind("UpdateQueryEvent",function(b,g,i){var j=g.concept_id,m;$.isEmptyObject(c)&&(k.detach(),f.append(l)),l.attr("disabled","true"),$.postJSON(h,JSON.stringify(g),function(b){l.removeAttr("disabled");var f=$.isEmptyObject(c);if(c.hasOwnProperty(j))m=a.Criteria(g,h,b),c[j].replaceWith(m),m.fadeTo(300,.5,function(){m.fadeTo("fast",1)});else{m=a.Criteria(g,h,b),i?e.prepend(m):e.append(m);var k=$.Event("ConceptAddedEvent");k.concept_id=j,d.trigger(k)}c[j]=m,i||(m.addClass("selected"),m.siblings().removeClass("selected")),f&&$(e.children()[0]).find(".field-anchor").click()},"text")}),d.bind("CriteriaRemovedEvent",function(a){var b=$(a.target),f=b.data("constraint");c[f.concept_id].remove(),delete c[f.concept_id];var g=$.Event("ConceptDeletedEvent");g.concept_id=f.concept_id,d.trigger(g),$.isEmptyObject(c)&&(e.append(k),l.detach())}),d.bind("ShowConceptEvent",function(a){var b=$(a.target);e.children(".criterion").removeClass("selected");if(b.is(".criterion"))b.addClass("selected");else{var d=a.originalEvent.concept_id;c[d]&&c[d].addClass("selected")}});return{retrieveCriteriaDS:function(a){var b=null;a&&$.each(e.children(),function(c,d){$(d).data("constraint")&&($(d).data("constraint").concept_id==a&&(b=$(d).data("constraint")))});return b}}}()});return c})