define(["cilantro/define/criteria"],function(a){var b='<button id="submit-query"><span class="icon arrow-r"/> <span>Get Report</span></button>',c=$("#user-criteria"),d={},e=c.find("#criteria-list"),f=c.find(".content"),g=c.find("#remove-criteria"),h=e.attr("data-uri"),i=e.attr("data-report"),j=c.attr("data-uri"),k=e.children(),l=$(b);$.getJSON(j,function(a){a.store!==null&&!$.isEmptyObject(a.store)&&(a.store.hasOwnProperty("concept_id")?c.triggerHandler("UpdateQueryEvent",[a.store,!0]):$.each(a.store.children.reverse(),function(a,b){c.triggerHandler("UpdateQueryEvent",[b,!0])}))}),l.click(function(){var a=[],b;for(var c in d)d.hasOwnProperty(c)&&a.push(d[c].data("constraint"));a.length<2?b=a[0]:b={type:"and",children:a},$.putJSON(j,JSON.stringify(b),function(){window.location=i})}),g.click(function(){for(var a in d)d.hasOwnProperty(a)&&d[a].trigger("CriteriaRemovedEvent")}),c.bind("UpdateQueryEvent",function(b,g,i){var j=g.concept_id,m;$.isEmptyObject(d)&&(k.detach(),f.append(l)),l.attr("disabled","true"),$.postJSON(h,JSON.stringify(g),function(b){l.removeAttr("disabled");var f=$.isEmptyObject(d);if(d.hasOwnProperty(j))m=a.Criteria(g,h,b),d[j].replaceWith(m),m.fadeTo(300,.5,function(){m.fadeTo("fast",1)});else{m=a.Criteria(g,h,b),i?e.prepend(m):e.append(m);var k=$.Event("ConceptAddedEvent");k.concept_id=j,c.trigger(k)}d[j]=m,i||(m.addClass("selected"),m.siblings().removeClass("selected")),f&&$(e.children()[0]).find(".field-anchor").click()},"text")}),c.bind("CriteriaRemovedEvent",function(a){var b=$(a.target),f=b.data("constraint");d[f.concept_id].remove(),delete d[f.concept_id];var g=$.Event("ConceptDeletedEvent");g.concept_id=f.concept_id,c.trigger(g),$.isEmptyObject(d)&&(e.append(k),l.detach())}),c.bind("ShowConceptEvent",function(a){var b=$(a.target);e.children(".criterion").removeClass("selected");if(b.is(".criterion"))b.addClass("selected");else{var c=a.originalEvent.concept_id;d[c]&&d[c].addClass("selected")}});return{retrieveCriteriaDS:function(a){var b=null;a&&$.each(e.children(),function(c,d){!$(d).data("constraint")||$(d).data("constraint").concept_id==a&&(b=$(d).data("constraint"))});return b}}})