define(["cilantro/define/criteria"],function(a){var b='<button id="submit-query"><span class="icon arrow-r"/> <span>Get Report</span></button>',c={};$(function(){var d=$("#user-criteria");(function(){var e={},f=d.find("#criteria-list"),g=d.find(".content"),h=d.find("#remove-criteria"),i=f.attr("data-uri"),j=f.attr("data-report"),k=d.attr("data-uri"),l=f.children(),m=$(b);$.getJSON(k,function(a){a.store!==null&&!$.isEmptyObject(a.store)&&(a.store.hasOwnProperty("concept_id")?d.triggerHandler("UpdateQueryEvent",[a.store,!0]):$.each(a.store.children.reverse(),function(a,b){d.triggerHandler("UpdateQueryEvent",[b,!0])}))}),m.click(function(){var a=[],b;for(var c in e)e.hasOwnProperty(c)&&a.push(e[c].data("constraint"));a.length<2?b=a[0]:b={type:"and",children:a},$.putJSON(k,JSON.stringify(b),function(){window.location=j})}),h.click(function(){for(var a in e)e.hasOwnProperty(a)&&e[a].trigger("CriteriaRemovedEvent")}),d.bind("UpdateQueryEvent",function(b,c,h){var j=c.concept_id,k;$.isEmptyObject(e)&&(l.detach(),g.append(m)),m.attr("disabled","true"),$.postJSON(i,JSON.stringify(c),function(b){m.removeAttr("disabled");var g=$.isEmptyObject(e);if(e.hasOwnProperty(j))k=a.Criteria(c,i,b),e[j].replaceWith(k),k.fadeTo(300,.5,function(){k.fadeTo("fast",1)});else{k=a.Criteria(c,i,b),h?f.prepend(k):f.append(k);var l=$.Event("ConceptAddedEvent");l.concept_id=j,d.trigger(l)}e[j]=k,h||(k.addClass("selected"),k.siblings().removeClass("selected")),g&&$(f.children()[0]).find(".field-anchor").click()},"text")}),d.bind("CriteriaRemovedEvent",function(a){var b=$(a.target),c=b.data("constraint");e[c.concept_id].remove(),delete e[c.concept_id];var g=$.Event("ConceptDeletedEvent");g.concept_id=c.concept_id,d.trigger(g),$.isEmptyObject(e)&&(f.append(l),m.detach())}),d.bind("ShowConceptEvent",function(a){var b=$(a.target);f.children(".criterion").removeClass("selected");if(b.is(".criterion"))b.addClass("selected");else{var c=a.originalEvent.concept_id;e[c]&&e[c].addClass("selected")}}),c.retrieveCriteriaDS=function(a){var b=null;a&&$.each(f.children(),function(c,d){$(d).data("constraint")&&($(d).data("constraint").concept_id==a&&(b=$(d).data("constraint")))});return b}})()});return c})