var __slice=Array.prototype.slice;(function(a){var b,c,d,e,f,g,h;f=1,h=1,g=1,e=function(){function a(a,b,c){this.publisher=a,this.handler=b,this.context=c,this.id=h++,this.online=!0,this.tip=null}return a}(),b=function(){function a(a,b){this.publisher=a,this.content=b,this.id=g++,this.previous=this.publisher.tip(),this.publisher.messages.push(this)}a.prototype.copy=function(){return this.content.slice()},a.prototype.available=function(){return this.publisher.active};return a}(),d=function(){function a(a){this.topic=a,this.subscribers=[],this.messages=[],this.active=!0}a.prototype.tip=function(){return this.messages[this.messages.length-1]},a.prototype._add=function(a){return this.subscribers.push(a)},a.prototype._remove=function(a){var b,c;b=this.subscribers.length,c=[];while(b--)if(a===this.subscribers[b]){this.subscriber.pop(b);break}return c};return a}(),c=function(){function a(a){this.debug=a!=null?a:!1,this.id=f++,this.publishers={},this.subscribers={},this.messages={}}a.prototype.version="0.3-undoless",a.prototype._addPublisher=function(a){var b;(b=this.publishers[a])||(b=new d(a),this.publishers[a]=b,this.log("Publisher '"+b.topic+"' added"));return b},a.prototype._addSubscriber=function(a,b,c){var d;d=new e(a,b,c),this.subscribers[d.id]=d,a._add(d),this.log("Subscriber #"+d.id+" added");return d},a.prototype.subscribe=function(a,b,c,d){var f,g,h;d==null&&(d=!0);if(a instanceof e)g=a,g.online=!0,f=g.publisher,d=b||d,this.log("Subscriber #"+g.id+" online");else{if(c===!0||c==="tip"||c===!1)h=[c,d],d=h[0],c=h[1];f=this._addPublisher(a),g=this._addSubscriber(f,b,c)}d&&this._migrate(f,g,d);return g},a.prototype.unsubscribe=function(a,b){b==null&&(b=!1);if(!(!a instanceof e&&!(a=this.subscribers[a]))){if(b){delete this.subscribers[a.id],a.publisher._remove(a);return this.log("Subscriber #"+a.id+" removed")}a.online=!1;return this.log("Subscriber #"+a.id+" offline")}},a.prototype.publish=function(){var a,b,c,d;d=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],c=this._addPublisher(d);if(!!c.active){this.log("'"+c.topic+"' published ->",a),b=this._record(c,a),this._applyToAll(b);return c}},a.prototype._migrate=function(a,b,c){var d,e;if(a.messages.length){c==="tip"?d=[a.tip()]:d=a.messages,e=b.tip?b.tip.id:-1;return this._migrateAll(d,b,e)}},a.prototype._migrateAll=function(a,b,c){var d,e,f,g;g=[];for(e=0,f=a.length;e<f;e++){d=a[e];if(d.id<=c)continue;g.push(this._applyToOne(d,b))}return g},a.prototype._applyToAll=function(a,b){var c,d,e,f;f=a.publisher.subscribers;for(d=0,e=f.length;d<e;d++)c=f[d],this._applyToOne(a,c,b)},a.prototype._applyToOne=function(a,b){if(!!b.online){this.log("Subscriber #"+b.id+" <-",a.content),b.handler.apply(b.context,a.copy());return b.tip=a}},a.prototype._record=function(a,c){var d;d=new b(a,c),this.messages[d.id]=this;return d};return a}(),(typeof console!="undefined"&&console!==null?console.log:void 0)?c.prototype.log=function(){var a,b;b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[];if(this.debug){b="Hub #"+this.id+": "+b;return a.length?console.log.apply(console,[b].concat(__slice.call(a))):console.log(b)}}:c.prototype.log=function(){};return a.PubSub=c})(window)