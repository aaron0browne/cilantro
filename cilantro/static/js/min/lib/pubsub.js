var __slice=Array.prototype.slice;(function(a){var b,c,d,e,f,g;Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),f=1,g=1,d=function(a,b,c,d){this.id=g++,this.topic=a,this.forwards=b,this.backwards=c,this.context=d||this,this.active=!0;return this},b=function(a,b,c){this.id=f++,this.topic=a,this.args=b,this.prev=c;return this},e=function(a){this.name=a,this.subscribers=[],this.history=[],this.active=!0;return this},c=function(){return new c.fn.init},c.version="0.1",c.fn=c.prototype={constructor:c,init:function(){this.topics={},this.publications={},this.subscribers={},this.undoStack=[],this.redoStack=[];return this},subscribe:function(a,b,c,f,g){var h,i,j,k,l,m,n;g==null&&(g="full");if(typeof a=="number"){if(!(j=this.subscribers[a]))return;j.active=!0,k=j.topic,i=b||i}else{if(!(k=this.topics[a]))k=this.topics[a]=new e(a);else if(!b||typeof b!="function"){k.active=!0;return}j=new d(k,b,c,f),this.subscribers[j.id]=j,k.subscribers.push(j)}if(g&&k.history.length){switch(g){case"full":n=k.history;for(l=0,m=n.length;l<m;l++){h=n[l];if(h.id>this.last.id)break;if(j.last&&j.last.id>=h.id)continue;j.forwards.apply(j.context,h.args)}break;case"tip":h=k.history.last();if(h.id>this.last.id)return;if(j.last&&j.last.id>=h.id)return;j.forwards.apply(j.context,h.args)}j.last=h}return j.id},unsubscribe:function(a,b){var c,d,e,f,g,h,i,j;b==null&&(b=!1);if(typeof a=="number"){d=this.subscribers[a];if(b){delete this.subscribers[a],e=d.topic.subscribers,c=e.length,j=[];while(c--)j.push(d.id===e[c].id?e.splice(c,1):void 0);return j}return d.active=!1}if(f=this.topics[a]){if(b){i=this.topics[a].subscribers;for(g=0,h=i.length;g<h;g++)d=i[g],delete this.subscribers[d.id];return delete this.topics[a]}return f.active=!1}},publish:function(){var a,b,c,d,f,g,h,i;b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[];if(!(f=this.topics[b]))f=this.topics[b]=new e(b);else if(!f.active)return;c=null,this.locked||(this._flushRedo(),c=this._recordPub(f,a));if(f.subscribers.length){i=f.subscribers;for(g=0,h=i.length;g<h;g++){d=i[g];if(!d.active)continue;this._transaction(d,c,a.slice(0))}}return c&&c.id},undo:function(){var a;if(a=this.undoStack.pop()){this.redoStack.push(a);return a.topic.active?this._backwards(a):this.undo()}},redo:function(){var a;if(a=this.redoStack.pop()){this.undoStack.push(a);return a.topic.active?this._forwards(a):this.redo()}},_transaction:function(a,b,c){if(!this.locked){this.locked=!0;try{a.forwards.apply(a.context,c);return a.last=b}finally{this.locked=!1}}else try{return a.forwards.apply(a.context,c)}catch(d){}},_forwards:function(a){var b,c,d,e,f;c=a.topic;if(c.subscribers.length){f=c.subscribers;for(d=0,e=f.length;d<e;d++){b=f[d];if(!b.active)continue;try{b.forwards.apply(b.context,a.args.slice(0))}finally{b.last=a}}}return this.last=a},_backwards:function(a){var b,c,d,e,f;c=a.topic;if(c.subscribers.length){f=c.subscribers;for(d=0,e=f.length;d<e;d++){b=f[d];if(!b.active)continue;try{b.backwards?b.backwards.apply(b.context,a.args.slice(0)):a.prev?b.forwards.apply(b.context,a.prev.args.slice(0)):b.forwards.apply(b.context)}finally{b.last=a}}}return this.last=a},_flushRedo:function(){var a,b,c,d,e,f;e=this.redoStack,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],a=this.redoStack.shift(),a.topic.history.pop(),f.push(delete this.publications[a.id]);return f},_recordPub:function(a,c){var d;d=new b(a,c,a.history.last()),this.publications[d.id]=d,a.history.push(d),this.undoStack.push(d);return this.last=d}},c.fn.init.prototype=c.fn;return a.PubSub=c})(window)