define(["cilantro/rest/datasource","cilantro/rest/renderer","cilantro/report/templates"],function(a,b,c){function e(){var e=!0,f=$("body"),g=$("#content"),h=$("#report"),i=$("#report-info"),j=$("#actions"),k=$("#details"),l=h.find(".toolbar"),m=$("#table"),n=m.find("thead tr"),o=m.find("tbody"),p=$(".per-page"),q=$(".page-links"),r=$("#unique-count"),s=$("#count"),t={table_header:new b.template({target:n,template:c.header}),table_rows:new b.template({target:o,template:c.row}),pages:new b.template({target:q,template:c.pages})},u={scope_info:new a.ajax({ajax:{url:API_URLS.scope,success:function(a){if(a.text){var b="";if(typeof a.text==="string")b="<li>"+a.text+"</li>";else{var c=a.text.conditions;for(var d=0;d<c.length;d++)b+="<li>"+c[d]+"</li>"}k.html(b)}}}}),table_header:new a.ajax({ajax:{url:API_URLS.perspective,success:function(a){t.table_header.render(a.header)}}}),table_rows:new a.ajax({ajax:{url:API_URLS.report,beforeSend:function(){h.block()},complete:function(){h.unblock()},success:function(a){a.unique!==undefined&&r.html(a.unique),a.count!==undefined&&s.html(a.count);a.count===0?($(".content").html(d).css("text-align","center"),j.hide()):(t.table_rows.render(a.rows),a.pages?t.pages.render(a.pages):(e&&p.hide(),t.pages.target.hide()),a.per_page&&p.val(a.per_page),h.trigger("resize-report"),e&&(e=!1,setTimeout(function(){i.show(),l.show(),m.show()},500)))}}})};u.scope_info.get(),u.table_header.get(),u.table_rows.get(),h.bind("resize-report",function(a){var b=900,c=h.innerWidth(),d=m.outerWidth(!0)+20;nInnerWidth=Math.min(d,$(window).width()-30),nInnerWidth=Math.max(b,nInnerWidth);nInnerWidth!=c&&(half=(nInnerWidth-c)/2,nLeft=parseInt(g.css("margin-left").match(/-?\d+/)[0])-half,g.animate({marginLeft:nLeft}),h.animate({width:nInnerWidth}))});var v;$(window).resize(function(){clearTimeout(v),v=setTimeout(function(){h.trigger("resize-report")},200)}),f.bind("update.report",function(a,b){var c={data:b};u.table_rows.get(c,!0);return!1}),f.bind("update.perspective",function(a,b){$.putJSON(API_URLS.perspective,JSON.stringify(b),function(){f.trigger("update.report"),"columns"in b&&u.table_header.get(null,!0)});return!1}),h.delegate(".per-page","change",function(a){this.value&&f.trigger("update.report",{n:this.value});return!1}),n.delegate(".header","click",function(a){var b,c=$(this),d=c.attr("data-id"),e=c.siblings();e.removeClass("asc").removeClass("desc"),c.hasClass("asc")?(c.removeClass("asc").addClass("desc"),b="desc"):c.hasClass("desc")?(c.removeClass("desc"),b=""):(c.addClass("asc"),b="asc"),f.trigger("update.perspective",[{ordering:[[d,b]]}]);return!1}),q.delegate("a","click",function(a){f.trigger("update.report",{p:this.hash.substr(1)});return!1})}var d='<div style="text-align: center; display: inline;" class="message warning">No results match your conditions. <a href="'+URLS.define+'">Refine your conditions</a>.</div>';return{init:e}})